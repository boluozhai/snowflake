<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" 
 "http://www.springframework.org/dtd/spring-beans-2.0.dtd" >
<beans>


	<!-- base -->


	<bean id='com.boluozhai.snowflake.rest.client.RESTClientFactory'
		class='com.boluozhai.snowflake.rest.support.DefaultRESTClientFactory'></bean>


	<bean id='rest:request-info:factory'
		class='com.boluozhai.snowflake.rest.server.support.DefaultRestRequestInfoFactory'>

		<property name="pathInfoFactory">
			<bean
				class='com.boluozhai.snowflake.rest.server.support.DefaultPathInfoFactory'>

				<property name="inAppPathPattern" value='~/user/repository/api/type/id/*' />

			</bean>
		</property>

		<property name="sessionInfoFactory">
			<bean
				class='com.boluozhai.snowflake.rest.server.support.DefaultSessionInfoFactory'></bean>
		</property>

	</bean>


	<!-- expression -->


	<bean id='rest:expression:root'
		class='com.boluozhai.snowflake.h2o.rest.expression.RootExpression' />

	<bean id='rest:expression:www-res'
		class='com.boluozhai.snowflake.h2o.rest.expression.WwwResExpression' />

	<bean id='rest:expression:rest-api'
		class='com.boluozhai.snowflake.h2o.rest.expression.RestApiExpression' />

	<bean id='rest:expression:info-refs-service'
		class='com.boluozhai.snowflake.h2o.rest.expression.InfoRefsExpression' />


	<!-- gateway -->


	<bean id='rest:gateway:root'
		class='com.boluozhai.snowflake.rest.server.support.handler.DefaultRequestHandler'>

		<property name="listeners">
			<list>

				<bean
					class='com.boluozhai.snowflake.rest.server.support.handler.InfoFactoryBindingListener'>

					<property name="factory">
						<ref bean='rest:request-info:factory' />
					</property>

				</bean>

				<bean
					class='com.boluozhai.snowflake.rest.server.support.handler.NginxProxyHttpsUrlPrepareListener'>
					<!-- nginx proxy https url prepare listener -->
				</bean>

			</list>
		</property>

		<property name="nextHanlder">
			<ref bean='rest:switch:root' />
		</property>

	</bean>


	<bean id='rest:gateway:info-refs-service'
		class='com.boluozhai.snowflake.rest.server.support.handler.DefaultRequestHandler'>

		<property name="nextHanlder">
			<ref bean='rest:switch:info-refs-service' />
		</property>

	</bean>


	<bean id='rest:gateway:www-res'
		class='com.boluozhai.snowflake.rest.server.support.handler.DefaultRequestHandler'>

		<property name="filters">
			<list>
				<!-- bean class='com.boluozhai.snowflake.rest.server.support.handler.DefaultRequestHandler' 
					/ -->
			</list>
		</property>

		<property name="nextHanlder">
			<ref bean='rest:switch:www-res' />
		</property>

	</bean>


	<bean id='rest:gateway:rest-api'
		class='com.boluozhai.snowflake.rest.server.support.handler.DefaultRequestHandler'>

		<property name="nextHanlder">
			<ref bean='rest:switch:rest-api' />
		</property>

	</bean>


	<!-- switch -->


	<bean id='rest:switch:root'
		class='com.boluozhai.snowflake.rest.server.support.handler.RestHandlerSwitch'>

		<property name="expression">
			<ref bean='rest:expression:root' />
		</property>

		<property name="defaultHandler">
			<ref bean='rest:gateway:www-res' />
		</property>

		<property name="handlers">
			<map>

				<entry key='www'>
					<ref bean='rest:gateway:www-res' />
				</entry>

				<entry key='info'>
					<ref bean='rest:gateway:info-refs-service' />
				</entry>

				<entry key='rest'>
					<ref bean='rest:gateway:rest-api' />
				</entry>

			</map>
		</property>

	</bean>




	<bean id='rest:switch:rest-api'
		class='com.boluozhai.snowflake.rest.server.support.handler.RestHandlerSwitch'>

		<!-- ~/rest/* -->

		<property name="expression">
			<ref bean='rest:expression:rest-api' />
		</property>

		<property name="defaultHandler">
			<bean class='com.boluozhai.snowflake.h2o.rest.controller.Http404Ctrl' />
		</property>

		<property name="handlers">
			<map>

				<!-- sys -->

				<entry key='account'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.AccountCtrl' />
				</entry>
				<entry key='auth'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.AuthCtrl' />
				</entry>
				<entry key='command'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.CommandCtrl' />
				</entry>
				<entry key='file'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.FileCtrl' />
				</entry>
				<entry key='repository'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.RepositoryCtrl' />
				</entry>
				<entry key='session'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.SessionCtrl' />
				</entry>
				<entry key='viewport'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.ViewportCtrl' />
				</entry>
				<entry key='working'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.WorkingDirCtrl' />
				</entry>

			</map>
		</property>

	</bean>





	<bean id='rest:switch:info-refs-service'
		class='com.boluozhai.snowflake.rest.server.support.handler.RestHandlerSwitch'>

		<!-- .../info/refs?service=??? -->

		<property name="expression">
			<bean
				class='com.boluozhai.snowflake.xgit.http.server.controller.InfoRefsSwitchExpression' />
		</property>


		<property name="defaultHandler">
			<bean
				class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitBadService' />
		</property>

		<property name="handlers">
			<map>
				<entry key='xgit-receive-objects'>
					<bean
						class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitReceiveObjects'></bean>
				</entry>
				<entry key='xgit-upload-objects'>
					<bean
						class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitUploadObjects'></bean>
				</entry>
				<entry key='xgit-receive-refs'>
					<bean
						class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitReceiveRefs'></bean>
				</entry>
				<entry key='xgit-upload-refs'>
					<bean
						class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitUploadRefs'></bean>
				</entry>
			</map>
		</property>

	</bean>


	<bean id='rest:switch:www-res'
		class='com.boluozhai.snowflake.rest.server.support.handler.RestHandlerSwitch'>

		<!-- active js -->

		<property name="expression">
			<ref bean='rest:expression:www-res' />
		</property>

		<property name="defaultHandler">
			<bean class='com.boluozhai.snowflake.h2o.rest.controller.DefaultWebCtrl' />
		</property>

		<property name="handlers">
			<map>

				<entry key='i18n.js'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.res.I18nJsCtrl'></bean>
				</entry>

				<entry key='current-session-info.js'>
					<bean
						class='com.boluozhai.snowflake.h2o.rest.controller.res.SessionJsCtrl'></bean>
				</entry>

				<entry key='--this.js'>
					<bean
						class='com.boluozhai.snowflake.h2o.rest.controller.res.SessionJsCtrl'></bean>
				</entry>

			</map>
		</property>

	</bean>



</beans>
