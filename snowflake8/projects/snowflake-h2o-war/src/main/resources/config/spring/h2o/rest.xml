<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" 
 "http://www.springframework.org/dtd/spring-beans-2.0.dtd" >
<beans>

	<bean id='com.boluozhai.snowflake.rest.client.RESTClientFactory'
		class='com.boluozhai.snowflake.rest.support.DefaultRESTClientFactory'></bean>


	<bean id='rest:request-info:factory'
		class='com.boluozhai.snowflake.rest.server.support.DefaultRestRequestInfoFactory'>

		<property name="pathInfoFactory">
			<bean
				class='com.boluozhai.snowflake.rest.server.support.DefaultPathInfoFactory'>

				<property name="inAppPathPattern" value='~/api/user/repository/type/id/*' />

			</bean>
		</property>

		<property name="sessionInfoFactory">
			<bean
				class='com.boluozhai.snowflake.rest.server.support.DefaultSessionInfoFactory'></bean>
		</property>

	</bean>


	<!-- gateway -->


	<bean id='rest:gateway:parent'
		class='com.boluozhai.snowflake.rest.server.support.handler.DefaultRequestHandler'>

		<property name="listeners">
			<list>
				<bean
					class='com.boluozhai.snowflake.rest.server.support.handler.InfoFactoryBindingListener'>

					<property name="factory">
						<ref bean='rest:request-info:factory' />
					</property>

				</bean>
			</list>
		</property>

	</bean>

	<bean id='rest:gateway:repo' parent='rest:gateway:parent'>

		<property name="nextHanlder">
			<bean
				class='com.boluozhai.snowflake.rest.server.support.handler.DefaultRequestHandler'>

				<property name="listeners">
					<list>
						<bean
							class='com.boluozhai.snowflake.xgit.http.server.listener.RepoInfoBindingListener'>
						</bean>
						<bean
							class='com.boluozhai.snowflake.h2o.rest.listener.XgitServiceRepoBindingListener'>
						</bean>
					</list>
				</property>

				<property name="nextHanlder">
					<ref bean='rest:switch:repo' />
				</property>

			</bean>
		</property>

	</bean>

	<bean id='rest:gateway:rest' parent='rest:gateway:parent'>

		<property name="nextHanlder">
			<ref bean='rest:switch:rest' />
		</property>

	</bean>



	<bean id='rest:gateway:resource' parent='rest:gateway:parent'>
		<property name="nextHanlder">
			<ref bean='rest:switch:resource' />
		</property>
	</bean>


	<!-- switch -->


	<bean id='rest:switch:rest'
		class='com.boluozhai.snowflake.rest.server.support.handler.RestHandlerSwitch'>

		<!-- ~/rest/* -->

		<property name="pathPartName">
			<value>type</value>
		</property>

		<property name="defaultHandler">
			<bean class='com.boluozhai.snowflake.h2o.rest.controller.Http404Ctrl'></bean>
		</property>

		<property name="handlers">
			<map>
				<entry key='account'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.AccountCtrl'></bean>
				</entry>
				<entry key='auth'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.AuthCtrl'></bean>
				</entry>
				<entry key='command'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.CommandCtrl'></bean>
				</entry>
				<entry key='file'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.FileCtrl'></bean>
				</entry>
				<entry key='repository'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.RepositoryCtrl'></bean>
				</entry>
				<entry key='session'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.SessionCtrl'></bean>
				</entry>
				<entry key='working'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.WorkingDirCtrl'></bean>
				</entry>
			</map>
		</property>

	</bean>


	<bean id='rest:switch:repo'
		class='com.boluozhai.snowflake.rest.server.support.handler.RestHandlerSwitch'>

		<!-- ~/repo/* -->

		<property name="pathPartName">
			<value>type</value>
		</property>

		<property name="defaultHandler">
			<bean
				class='com.boluozhai.snowflake.xgit.http.server.controller.RepoHomeCtrl'></bean>
		</property>

		<property name="handlers">
			<map>
				<entry key='info'>
					<ref bean='rest:switch:info-refs-service' />
				</entry>
			</map>
		</property>

	</bean>



	<bean id='rest:switch:info-refs-service'
		class='com.boluozhai.snowflake.rest.server.support.handler.RestHandlerSwitch'>

		<!-- .../info/refs?service=??? -->

		<property name="expression">
			<bean
				class='com.boluozhai.snowflake.xgit.http.server.controller.InfoRefsSwitchExpression' />
		</property>

		<property name="defaultHandler">
			<bean
				class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitBadService' />
		</property>

		<property name="handlers">
			<map>
				<entry key='xgit-receive-objects'>
					<bean
						class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitReceiveObjects'></bean>
				</entry>
				<entry key='xgit-upload-objects'>
					<bean
						class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitUploadObjects'></bean>
				</entry>
				<entry key='xgit-receive-refs'>
					<bean
						class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitReceiveRefs'></bean>
				</entry>
				<entry key='xgit-upload-refs'>
					<bean
						class='com.boluozhai.snowflake.xgit.http.server.controller.service.XgitUploadRefs'></bean>
				</entry>
			</map>
		</property>

	</bean>


	<bean id='rest:switch:resource'
		class='com.boluozhai.snowflake.rest.server.support.handler.RestHandlerSwitch'>

		<property name="expression">
			<bean
				class='com.boluozhai.snowflake.h2o.rest.controller.res.ResourceSwitchExpression' />
		</property>

		<property name="defaultHandler">
			<bean class='com.boluozhai.snowflake.h2o.rest.controller.Http404Ctrl' />
		</property>

		<property name="handlers">
			<map>
				<entry key='~/js/config/i18n.js'>
					<bean class='com.boluozhai.snowflake.h2o.rest.controller.res.I18nJsCtrl'></bean>
				</entry>
				<entry key='~/js/session/current-session-info.js'>
					<bean
						class='com.boluozhai.snowflake.h2o.rest.controller.res.SessionJsCtrl'></bean>
				</entry>
			</map>
		</property>

	</bean>



</beans>
